<html>

<style>
    /* html {
        text-align: center;
        font-size: 16px;
    }

    div {
        padding: 1rem;
    }

    #input {
        font-size: 16px;
    }

    p {
        font-size: 16px;
    } */
</style>
<link href="/assets/jsonViewer.css" rel="stylesheet" type="text/css" />
<link href="/assets/style.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="/assets/jsonViewer.js"></script>
<script>
    // document.documentElement.style.setProperty('--logWindowWidth', "50%");
    // document.documentElement.style.setProperty('--logWindowHeight', "50%");
    // console.log(document.documentElement.style.getProperty('--logWindowWidth'))
    // console.log(document.documentElement.style.getProperty('--logWindowHeight'))

    const numLogsToRead = 10
    const socket = new WebSocket("ws://" + window.location.hostname + ":7777/liveLogs");

    socket.onopen = function () {
        console.log('ws connected')
    };

    socket.onmessage = async function (e) {
        let json
        if (typeof e.data.text !== "undefined") {
            json = JSON.parse(await e.data.text())
        } else {
            json = JSON.parse(e.data)

        }
        const JsonData = JSON.parse(json.data)
        console.log(json.time, JSON.parse(json.data))
        console.log(JsonData.tag)
        console.log(typeof getElByClass("tag:" + JsonData.tag))

        let container
        if (typeof JsonData.tag !== "undefined") {
            if (typeof getElByClass("tag:" + JsonData.tag) === 'undefined') {
                container = createLogWindow(JsonData.tag)
                setLogWindowWH()
            } else {
                container = getElByClass("tag:" + JsonData.tag)
            }
        } else {
            container = getElByClass("tag:")
        }
        new JsonViewer({
            container: container,
            dateTime: getDateTime(json.time),
            data: json.data,
            theme: 'dark',
            expand: true
        });
        container.scrollTop = container.scrollHeight;


    }

    function setLogWindowWH() {
        const maxCols = 4
        const cols = document.getElementsByClassName('logWindow').length
        if (cols <= maxCols) {
            document.documentElement.style.setProperty('--logWindowWidth', (100 / cols) + "%");
        } else {
            document.documentElement.style.setProperty('--logWindowWidth', "25%");
            const rows = Math.ceil(cols / maxCols)
            document.documentElement.style.setProperty('--logWindowHeight', (100 / rows) + "%");
        }

    }

    function getDateTime(nanotime) {
        var d = new Date(Math.round(nanotime / 1000000));
        const counter = getCount(d.getHours() + '' + d.getMinutes())
        return counter + "(" + d.getHours() + ':' + d.getMinutes() + ') ' + d.getSeconds() + ':' + d.getMilliseconds() + " | " + d.getDate() + '/' + (d.getMonth()) + '/' + d.getFullYear() + " | "
    };

    let counter = {}

    function getCount(time) {
        if (Object.keys(counter).includes(time)) {
            counter[time] += 1
            return counter[time]
        } else {
            counter[time] = 0
            return 0
        }
    }


    function createLogWindow(tag) {
        const logWindow = document.createElement("div")
        logWindow.classList.add("logWindow")
        logWindow.classList.add("tag:" + tag)
        const tagName = document.createElement("div")
        tagName.classList.add("tagName")
        tagName.appendChild(document.createTextNode(tag))
        logWindow.appendChild(tagName)
        const maximize = document.createElement("div")
        maximize.classList.add("maximize")
        maximize.addEventListener('click', event => {
            console.log(logWindow.classList)
            if (logWindow.classList.contains('maxed')) {
                logWindow.classList.remove("maxed")
            } else {
                logWindow.classList.add("maxed")
            }
        });
        tagName.appendChild(maximize)


        getElByClass("logsContainer").appendChild(logWindow)
        return logWindow
    }

    function getElByClass(classname) {
        return document.getElementsByClassName(classname)[0]
    }


</script>


<body>

    <div class="logsContainer">

    </div>



    <script>
        createLogWindow("")
    </script>


</body>


</html>